<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>名古屋親子美食購物七日行程 — Final </title>
    <!-- Tailwind CDN：確保樣式與畫布預覽一致 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Speed hints for image proxy/CDN -->
    <link rel="dns-prefetch" href="https://images.weserv.nl">
    <link rel="preconnect" href="https://images.weserv.nl" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&family=Noto+Serif+TC:wght@700;800&display=swap" rel="stylesheet">
    <style>
      summary::-webkit-details-marker { display: none; }
      body { font-family: 'Noto Sans TC', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, 'PingFang TC', 'Microsoft JhengHei', 'Noto Sans CJK TC', sans-serif; }
      .title-font { font-family: 'Noto Serif TC', ui-serif, Georgia, serif; letter-spacing: .2px; }

      /* Gallery layout */
      .gallery-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: .5rem; }
      @media (min-width: 768px) { .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); } }
      .gallery-item { overflow:hidden; border-radius: .5rem; border:1px solid rgb(229 231 235); background:#fff; }
      .aspect-fixed { aspect-ratio: 4/3; }
      .gallery-item img { width:100%; height:100%; object-fit: cover; display:block; }

      /* Toggle: natural aspect ratio mode */
      .mode-natural .gallery-item { aspect-ratio: auto; }
      .mode-natural .gallery-item img { height:auto; object-fit: contain; background:#000; }

      /* Lightbox */
      dialog#lightbox { width: min(96vw, 1200px); border: none; padding: 0; background: transparent; }
      dialog#lightbox::backdrop { background: rgba(0,0,0,.7); }
      .lightbox-inner { position: relative; padding: .5rem; background: #000; border-radius: .75rem; }
      .lightbox-img { max-width: 92vw; max-height: 86vh; display: block; margin: auto; }
      .lightbox-close { position:absolute; top:.5rem; right:.5rem; background: rgba(255,255,255,.9); border: 1px solid rgb(229 231 235); padding: .25rem .5rem; border-radius: .5rem; font-size: .875rem; }
    
    </style>
  </head>
  <body class="min-h-screen bg-neutral-50 body-font">
    <!-- 頂部工具列 -->
    <div class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-white/70 bg-white/80 border-b">
      <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
        <div class="flex items-center gap-2">
          <span class="inline-block w-5 h-5 rounded bg-black"></span>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight title-font">名古屋親子美食購物七日行程</h1>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button id="modeToggle" class="border rounded-md px-3 py-1.5 text-xs">顯示模式：一致尺寸</button>
                    <button id="dljson" class="bg-black text-white rounded-md px-3 py-1.5 text-xs">匯出 JSON</button>
        </div>
      </div>
    </div>    <main class="mx-auto max-w-6xl px-4 pb-16 pt-6">
      <!-- Hero -->
      <section class="mb-6">
        <div class="relative overflow-hidden rounded-2xl border shadow-sm">
          <img src="https://www.legoland.jp/media/lvqbobyy/entrance_3-1.jpg" alt="Hero" class="w-full h-64 object-cover" fetchpriority="high" referrerpolicy="no-referrer" crossorigin="anonymous">
        </div>
      </section>

      <div class="my-6 border-t"></div>

      <!-- 航班區塊 -->
      <section class="mb-8" id="flights">
        <div class="flex items-center gap-2 py-2">
          <span class="text-xl">✈️</span>
          <h2 class="text-2xl font-semibold tracking-tight title-font">航班</h2>
        </div>
        <div class="shadow-sm rounded-xl border bg-white scroll-mt-24">
          <div class="p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 去程 -->
            <div class="rounded-xl border p-4">
              <div class="flex items-center gap-2 mb-2"><span class="inline-flex items-center justify-center rounded-full bg-gray-100 border px-2 py-0.5 text-xs">去程</span></div>
              <div class="text-base text-gray-700 font-medium">日本航空 JAL</div>
              <div class="flex items-center gap-2 mt-1 text-sm"><span class="inline-flex items-center rounded-full bg-gray-100 border px-2 py-0.5">JL8670</span><span>2025/08/31 (日)</span></div>
              <div class="grid grid-cols-2 gap-2 items-center mt-2 text-base">
                <div class="flex items-center gap-2 text-lg font-semibold">14:05</div>
                <div class="text-right text-gray-500">桃園機場 第2航廈 (TPE T2)</div>
                <div class="flex items-center gap-2 text-lg font-semibold">17:50</div>
                <div class="text-right text-gray-500">中部國際機場 第1航廈 (NGO T1)</div>
              </div>
            </div>
            <!-- 回程 -->
            <div class="rounded-xl border p-4">
              <div class="flex items-center gap-2 mb-2"><span class="inline-flex items-center justify-center rounded-full bg-gray-100 border px-2 py-0.5 text-xs">回程</span></div>
              <div class="text-base text-gray-700 font-medium">日本航空 JAL</div>
              <div class="flex items-center gap-2 mt-1 text-sm"><span class="inline-flex items-center rounded-full bg-gray-100 border px-2 py-0.5">JL8671</span><span>2025/09/06 (六)</span></div>
              <div class="grid grid-cols-2 gap-2 items-center mt-2 text-base">
                <div class="flex items-center gap-2 text-lg font-semibold">10:40</div>
                <div class="text-right text-gray-500">中部國際機場 第1航廈 (NGO T1)</div>
                <div class="flex items-center gap-2 text-lg font-semibold">12:45</div>
                <div class="text-right text-gray-500">桃園機場 第2航廈 (TPE T2)</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 每日行程（由 JS 動態產生） -->
      <section class="mb-8" id="itinerary">
        <div class="flex items-center gap-2 py-2">
          <span class="text-xl">🗓️</span>
          <h2 class="text-2xl font-semibold tracking-tight title-font">每日行程</h2>
        </div>
        <div id="itineraryList" class="space-y-6"></div>
      </section>

      <!-- Lightbox (click-to-zoom) -->
      <dialog id="lightbox">
        <div class="lightbox-inner">
          <img id="lightboxImg" class="lightbox-img" alt="preview">
          <button id="lightboxClose" class="lightbox-close">關閉 ✕</button>
        </div>
      </dialog>

    </main>

    <script>
      // 匯出 JSON（與頁面內容同步的資料結構）
      const DATA = {
        title: "名古屋親子美食購物七日行程",
        subtitle: "",
        hero: { image: "https://www.legoland.jp/media/lvqbobyy/entrance_3-1.jpg", caption: "" },
        flights: {
          outbound: { airline: "日本航空 JAL", number: "JL8670", date: "2025/08/31 (日)", depTime: "14:05", dep: "桃園機場 第2航廈 (TPE T2)", arrTime: "17:50", arr: "中部國際機場 第1航廈 (NGO T1)" },
          inbound:  { airline: "日本航空 JAL", number: "JL8671", date: "2025/09/06 (六)", depTime: "10:40", dep: "中部國際機場 第1航廈 (NGO T1)", arrTime: "12:45", arr: "桃園機場 第2航廈 (TPE T2)" }
        },
        itinerary: [
          { day:1, date:"2025/08/31 (日)", title:"抵達名古屋・入住飯店", gallery:[
              "https://photo.settour.com.tw/900x600/https://www.settour.com.tw/ss_img/info/location/NGO/O0/NGO0000012/NGO0000012_56401.jpg",
              "https://www.princehotels.co.jp/nagoya/images/night-view%20meieki01.jpg",
              "https://www.princehotels.co.jp/nagoya/experience/common/img/img_cont06-1.jpg"
            ] },
          { day:2, date:"2025/09/01 (一)", title:"樂高樂園親子冒險日", gallery:[
              "https://www.legoland.jp/media/pjagn2v5/hero_re3.jpg",
              "https://www.legoland.jp/media/vzifm0xv/1daypass.jpg",
              "https://www.legoland.jp/media/kvymb2eh/%E7%AB%9C%E5%AE%AE%E5%9F%8E.jpg?format=webp&quality=80&width=1920&height=768"
            ] },
          { day:3, date:"2025/09/02 (二)", title:"名古屋港水族館・LaLaport 購物・Anitouch 室內動物園", gallery:[
              "https://nagoyaaqua.jp/images/language/img6.jpg",
              "https://nagoyaaqua.jp/images/language/img1.jpg",
              "https://www.nagoya.anitouch.com/wp-content/themes/anitouch/assets/img/top/nekoashi.png"
            ] },
          { day:4, date:"2025/09/03 (三)", title:"吉卜力公園夢幻探險", gallery:[
              "https://ghibli-park.jp/site/img/about/daisouko/img12.jpg",
              "https://www.nagoya-info.jp/upload/spots/large/121592624163c0b4cc69d85.jpg",
              "https://www.nagoya-info.jp/upload/spots/large/173925933163c0b45bde951.jpg",
              "https://magazine.atnavi.net/wp-content/uploads/2024/03/DSC_6618-1024x682.jpg"
            ] },
          { day:5, date:"2025/09/04 (四)", title:"久屋大通公園散步・榮區逛街購物", gallery:[
              "https://www.nagoya-info.jp/upload/spots/large/20368120235f5f2bd90de30.jpg",
              "https://www.nagoya-info.jp/upload/spots/large/111069977762259ea6adcb8.jpg",
              "https://chiikawa-info.jp/chiikawaland/nagoya/img/main_02.jpg",
              "https://pokemonnewspaper.com.au/wp-content/uploads/2024/10/Screenshot-2024-10-18-104428s.png"
            ] },
          { day:6, date:"2025/09/05 (五)", title:"名古屋車站購物・機場前夜", gallery:[
              "https://www.nagoya-info.jp/upload/spots/large/15516837935e46533ce5220.jpg",
              "https://www.centrair.jp/flight-of-dreams/assets/images/flight-park/img-kv.jpg"
            ] },
          { day:7, date:"2025/09/06 (六)", title:"返家（早班機）", gallery:[
              "https://www.centrair.jp/assets/img/event/enjoy-skydeck-slide-img03.jpg"
            ] }
        ]
      };

      // 每日細節（瘦身：以資料結構呈現，統一由 JS 渲染；之後可直接把 Word 內容同步進來覆蓋這裡）
      const DETAILS = {
        1: {
          transport: [
            "機場 NGO → 名鐵名古屋：搭『μ-SKY』約30分；或一般特急35–40分；皆可用 IC 卡。",
            "名古屋駅 → ささしまライブ：青波線1站步行可達；亦可步行/計程車；GLOBAL GATE 有連通動線。"
          ],
          meals: { 
            breakfast: "—", 
            lunch: "機上/自理", 
            dinner: "Sasashima Live 周邊輕食/餐廳（例：Dining & Bar ONEONE、L'Amour 等）" 
          },
          lodging: "名古屋天空塔王子飯店（GLOBAL GATE）",
          summary: "抵達NGO → 名鐵進市區，入住 名古屋天空塔王子飯店（GLOBAL GATE），晚間可逛 MaxValu 或商場簡單覓食。",
          sections: [
            { title: "住宿資訊", items: ["名古屋天空塔王子飯店；地址：愛知県名古屋市中村区平池町4-60-12；Check-in 15:00 起。"] },
            { title: "周邊/便利", items: ["GLOBAL GATE 內設 FamilyMart；商圈餐廳/咖啡多，生活機能佳。","FamilyMart 常見 07:00–23:00（以現場為準）。","MaxValu 24hr 超市（步行約 600m），晚間採買備案。"] },
            { title: "親子提醒", items: ["提前備妥 IC 卡；把隔日樂高樂園用品先整理好。","首日晚到以入住與休息為主，無安排正式觀光。"] }
          ]
        },
        2: {
          transport: [
            "飯店 → ささしまライブ駅：步行約5分。",
            "ささしまライブ → 金城ふ頭：青波線約24分；約每15分一班，建議 08:00–08:30 搭乘。",
            "金城ふ頭駅 → 樂高樂園：沿 Maker’s Pier 步行約7分抵入口。"
          ],
          meals: { 
            breakfast: "飯店/便利商店；麥當勞可快速補給", 
            lunch: "園內餐廳（Bricks／Knight’s Table 等）", 
            dinner: "名古屋駅周邊：ESCA 地下街（矢場豬排、風來坊 等）" 
          },
          lodging: "名古屋天空塔王子飯店（GLOBAL GATE）",
          summary: "青波線前往 樂高樂園／SEA LIFE，晚餐回名站 ESCA 地下街（矢場豬排、風來坊）。",
          sections: [
            { title: "園區重點", items: ["七大主題區，從動手創作到雲霄飛車皆有。","迷你樂園（Miniland）：以積木重現日本城市地標。"] },
            { title: "遊樂/表演", items: ["騎士王國：The Dragon 雲霄飛車。","探險區：Lost Kingdom Adventure 射擊互動。","忍者世界：主題遊樂與表演。","海盜/水上區：可能濺濕，夏季清涼。"] },
            { title: "園內購物", items: ["The Big Shop 限定商品；Maker’s Pier 周邊親子商店。"] },
            { title: "名站購物", items: ["Disney Store（名古屋站周邊）。"] },
            { title: "裝備建議", items: ["水上區請備泳衣、防曬、替換衣物與毛巾。","SEA LIFE 水族館與樂高樂園連通（常見為套票，可彈性安排進出）。"] }
          ]
        },
        3: {
          transport: [
            "水上交通：ささしまライブ 運河碼頭 → 名古屋港，名古屋水上巴士／觀光船約40–60分。",
            "觀光船範例班次：9:30 → 10:14（實際以官網為準）。",
            "陸上交通：或改搭地鐵名港線至名古屋港（水族館出站步行可達）。",
            "名古屋港 → LaLaport：步行約10–15分，或地鐵1站。"
          ],
          meals: { breakfast: "便利商店 Family", lunch: "水族館或 LaLaport 美食街", dinner: "LaLaport 餐廳街" },
          lodging: "名古屋天空塔王子飯店（GLOBAL GATE）",
          summary: "搭觀光船至 名古屋港水族館，之後逛 LaLaport 與 Anitouch（室內動物園）。",
          sections: [
            { title: "名古屋港水族館重點", items: ["南館：南極/赤道海域；北館：海豚/虎鯨等。","親子互動展區豐富，適合半日以上停留。"] },
            { title: "表演/動線", items: ["海豚秀等熱門，建議先看場次表規劃動線。"] },
            { title: "購物/設施", items: ["紀念品店：海洋主題玩偶與教具。","LaLaport：親子服飾、動漫周邊、文具；設有親子遊樂區，雨天備案佳。","Anitouch 位於 LaLaport 2F 的室內動物園，全天候營運。"] },
            { title: "營業時間", items: ["水族館常見 9:30–17:30；LaLaport 10:00–21:00（餐飲或至22:00）；Anitouch 10:00–19:00（以官網為準）。"] }
          ]
        },
        4: {
          transport: ["名古屋駅 → 藤が丘駅：地鐵東山線約30分。","藤が丘 → 愛・地球博記念公園駅：Linimo 約15分。"],
          meals: { 
            breakfast: "Komeda", 
            lunch: "園內咖啡廳輕食", 
            dinner: "名古屋駅／Sasashima Live；榮區：馬喰一代（～23:00）" 
          },
          lodging: "名古屋天空塔王子飯店（GLOBAL GATE）",
          summary: "Linimo 進 吉卜力公園（大倉庫／Dondoko之森），晚餐可至 榮區 馬喰一代，順遊 綠洲21／唐吉訶德。",
          sections: [
            { title: "分區/亮點", items: ["青春之丘、吉卜力大倉庫、Dondoko之森、魔法故里、魔女之谷（多區需分別購票）。","大倉庫：經典場景展示（貓巴士、機器人兵）。","Dondoko之森：《龍貓》；魔女之谷：《魔女宅急便》。"] },
            { title: "票券/建議", items: ["熱門時段門票易售罄，建議至少提前2個月預訂。","園區步行量大，請穿好走鞋，夏季注意防曬補水。"] },
            { title: "營運提醒", items: ["週二常態休園（逢假日調整）；Linimo 約10分一班，請以官網為準。"] },
            { title: "回程順遊", items: ["綠洲21","唐吉訶德"] }
          ]
        },
        5: {
          transport: ["飯店 → 榮/久屋大通：地鐵約10–15分（名城線或東山線）。"],
          meals: { 
            breakfast: "VIE DE FRANCE 榮地下街; 公園周邊咖啡廳早午餐；Blue Bottle 藍瓶（中日大樓）", 
            lunch: "百貨餐廳街；HARBS 榮本店下午茶（11:00–22:00）", 
            dinner: "榮區/地下街自理；蓬萊軒（松坂屋南館10F，LO 20:30)" 
          },
          lodging: "名古屋天空塔王子飯店（GLOBAL GATE）",
          summary: "久屋大通～榮區 百貨與地下街、名古屋 PARCO（角色雜貨／寶可夢中心），餐飲可選 HARBS、蓬萊軒、Blue Bottle。",
          sections: [
            { title: "購物重點", items: ["三越：精品/地下美食；松坂屋：規模大、類別齊全；地下街：平價服飾與藥妝。","Parco：東館 2F/3F 角色雜貨（Jump Shop、Sanrio 等）。","寶可夢中心：2024/10/12 搬至名古屋 PARCO 東館2樓。","大須商店街：古著/二手、動漫周邊與小吃的庶民商圈（可與榮區銜接安排）。"] },
            { title: "PARCO 業態導覽", items: ["B1：貓福珊迪｜2F：寶可夢中心｜3F：懶懶熊・米菲・史努比・吉伊卡哇｜4F：animate & 扭蛋。"] },
            { title: "實用資訊", items: ["PARCO 各層皆有電梯；東館建議預留 1.5–2 小時。","營業時間：Parco 10:00–21:00（以現場為準）。"] }
          ]
        },
        6: {
          transport: ["名古屋駅 → 中部國際機場：名鐵特急約30–40分，班次密集。","機場步行動線完善，辦理入住後可直接前往設施。"],
          meals: { 
            breakfast: "名站：星巴克／星乃珈琲店／麥當勞 可作替代", 
            lunch: "車站百貨美食街", 
            dinner: "機場餐廳街（甜點：弁才天 水果大福）" 
          },
          lodging: "中部空港新特麗亞飯店",
          summary: "名站採買 JR 高島屋／名鐵百貨／BIC CAMERA、JR Gate Tower；午後轉往機場，探訪 Flight of Dreams。",
          sections: [
            { title: "購物 & 活動", items: ["JR 高島屋、名鐵百貨、地下街、BIC CAMERA 作為最後採買點。","機場免稅店：返台前最後補貨點。","JR Gate Tower（餐飲/展望）。","Disney Store（名站）。"] },
            { title: "Flight of Dreams", items: ["展示 Boeing 787、駕駛艙模擬與 AR 互動，建議 15:00 前抵達。"] },
            { title: "設施/親子", items: ["機場餐廳街多元；設有哺乳室與兒童遊戲區。","若行李較多，建議提早辦理機場飯店 Check-in。"] },
            { title: "營運/時刻", items: ["Flight of Dreams 常見 10:00–17:00；名鐵特急請行前查時刻表。"] }
          ]
        },
        7: {
          transport: ["機場飯店 → 航廈：步行約5分，可先於便利商店購買早餐。"],
          meals: { breakfast: "便利商店/咖啡廳", lunch: "—／飛機餐（視航班供餐）", dinner: "—" },
          lodging: "—",
          summary: "步行至航廈辦理登機，視時間最後逛免稅店後返家。",
          sections: [ { title: "出發提醒", items: ["步行 5 分鐘可達航廈，請預留安檢與稅務時間。","若時間充裕，可最後逛免稅店購買伴手禮與零食。"] } ]
        }
      };

      // 下載 JSON 檔
      document.getElementById('dljson').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify({DATA, DETAILS}, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'nagoya-ezstyle.json'; a.click(); URL.revokeObjectURL(url);
      });

      // 工具：產生清單 & 小節 HTML
      // 既有品牌/景點官方連結（僅匹配完全詞）
      const POI_LINKS = {
        "樂高樂園": "https://www.legoland.jp/",
        "LEGOLAND": "https://www.legoland.jp/",
        "SEA LIFE": "https://www.legoland.jp/",
        "Anitouch": "https://www.nagoya.anitouch.com/",
        "吉卜力公園": "https://ghibli-park.jp/",
        "名古屋港水族館": "https://www.nagoyaaqua.jp/",
        "綠洲21": "https://www.oasis-21.jp/",
        "唐吉訶德": "https://www.donki.com/",
        "名古屋 PARCO": "https://nagoya.parco.jp/",
        "PARCO": "https://nagoya.parco.jp/",
        "Parco": "https://nagoya.parco.jp/",
        "寶可夢中心": "https://www.pokemon.co.jp/",
        "HARBS": "https://www.harbs.co.jp/",
        "蓬萊軒": "https://www.horaiken.co.jp/",
        "Blue Bottle": "https://bluebottlecoffee.jp/",
        "藍瓶": "https://bluebottlecoffee.jp/",
        "Komeda": "https://www.komeda.co.jp/",
        "VIE DE FRANCE": "https://www.viedefrance.co.jp/",
        "JR Gate Tower": "https://www.towers.jp/",
        "JR 高島屋": "https://www.jr-takashimaya.co.jp/",
        "名鐵百貨": "https://www.e-meitetsu.com/",
        "BIC CAMERA": "https://www.biccamera.co.jp/",
        "Flight of Dreams": "https://www.centrair.jp/flight-of-dreams/",
        "名古屋天空塔王子飯店": "https://www.princehotels.co.jp/nagoya/",
        "ESCA 地下街": "https://www.esca-sc.com/",
        "矢場豬排": "https://www.yabaton.com/",
        "風來坊": "https://www.furaibou.com/",
        "Disney Store": "https://www.disney.co.jp/store/"
      };
      const escReg = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

      function linkify(txt=''){
        let out = String(txt ?? '');
        // Longer keywords first to avoid partial-shadowing (e.g., "名古屋 PARCO" before "PARCO")
        const entries = Object.entries(POI_LINKS).sort((a,b)=>b[0].length-a[0].length);
        // Use placeholders to avoid nested replacements when keys overlap
        const placeholders = [];
        entries.forEach(([k,url], idx)=>{
          if(!k) return;
          const ph = `__POI_${idx}__`;
          if (out.indexOf(k) !== -1) {
            out = out.split(k).join(ph);
            placeholders[idx] = `<a href="${url}" target="_blank" rel="noopener" class="underline decoration-dotted">${k}</a>`;
          } else {
            placeholders[idx] = null;
          }
        });
        placeholders.forEach((html, idx)=>{
          if(html) out = out.split(`__POI_${idx}__`).join(html);
        });
        return out;
      }
      const ul = items => `<ul class="list-disc pl-5 space-y-1">${(items||[]).map(i=>`<li>${linkify(i)}</li>`).join('')}</ul>`;

      const mealsBlock = m => `
        <div class="rounded-xl border p-3 text-sm bg-white">
          <div class="flex items-center gap-2 mb-2">🍽️ 三餐</div>
          <ul class="space-y-1">
            <li>早餐：${linkify((m && m.breakfast) || '')}</li>
            <li>午餐：${linkify((m && m.lunch) || '')}</li>
            <li>晚餐：${linkify((m && m.dinner) || '')}</li>
          </ul>
        </div>`;

      const lodgingBlock = txt => `
        <div class="rounded-xl border p-3 text-sm bg-white">
          <div class="flex items-center gap-2 mb-2">🛏️ 住宿</div>
          <div>${linkify(txt || '')}</div>
        </div>`;

      const galleryHTML = (day, urls=[]) => `
        <div class="gallery-grid mt-2" data-day="${day}">
          ${urls.map(u=>`<div class="gallery-item aspect-fixed"><img src="${u}" alt="d${day}" class="w-full h-full object-cover cursor-zoom-in" loading="lazy" decoding="async" referrerpolicy="no-referrer" crossorigin="anonymous"></div>`).join('')}
        </div>`;

      const cardHTML = (d, det) => `
        <div id="day-${d.day}" class="shadow-sm rounded-xl border bg-white scroll-mt-24">
          <div class="p-4 border-b">
            <div class="flex items-baseline justify-between flex-wrap gap-2">
              <div class="flex items-center gap-3">
                <span class="inline-flex items-center justify-center rounded-full bg-black text-white px-3 py-1 text-base md:text-lg font-semibold">第 ${d.day} 天</span>
                <span class="text-lg md:text-2xl font-semibold tracking-tight">${d.date}</span>
              </div>
            </div>
            <div class="text-xl md:text-2xl mt-2 font-semibold">${linkify(d.title)}</div>
          </div>
          ${(det.summary ? `<div class="px-4 pt-2 text-gray-700 text-sm md:text-base">${linkify(det.summary)}</div>` : '')}
          ${galleryHTML(d.day, d.gallery)}
          <!-- 交通動線 -->
          <div class="rounded-xl border p-3 text-sm bg-white mt-2">
            <div class="flex items-center gap-2 mb-2">🚆 交通動線</div>
            ${ul(det.transport || [])}
          </div>
          <!-- 餐食/住宿 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
            ${mealsBlock(det.meals || {})}
            ${lodgingBlock(det.lodging || '')}
          </div>
          <!-- 展開行程內容 -->
          <details class="border rounded-xl mt-2 mb-6 group">
            <summary class="w-full flex items-center justify-between px-3 py-2 text-sm cursor-pointer list-none">
              <span class="flex items-center gap-2"><span class="chev transition-transform group-open:rotate-180">▾</span> 展開行程內容</span>
            </summary>
            <div class="px-4 pb-3 text-sm text-gray-600 space-y-4">
              ${(det.sections||[]).map(sec=>`
                <div>
                  <div class="font-medium text-gray-800 mb-1">${sec.title}</div>
                  ${ul(sec.items||[])}
                </div>
              `).join('')}
            </div>
          </details>
        </div>`;

      // 產生每日行程卡片
      function renderItinerary(){
        const wrap = document.getElementById('itineraryList');
        wrap.innerHTML = DATA.itinerary.map(d => cardHTML(d, DETAILS[d.day]||{})).join('');
      }

      // 圖片展示模式切換（一致尺寸 ⇄ 原比例）
      function bindModeToggle(){
        const btn = document.getElementById('modeToggle');
        if(!btn) return;
        const sync = () => btn.textContent = document.body.classList.contains('mode-natural') ? '顯示模式：原比例' : '顯示模式：一致尺寸';
        btn.addEventListener('click', ()=>{ document.body.classList.toggle('mode-natural'); sync(); });
        sync();
      }

      // Lightbox（點圖放大 / Esc 關閉 / 點背景關閉）
      function bindLightbox(){
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightboxImg');
        const lbClose = document.getElementById('lightboxClose');
        if(!lb || !lbImg) return;
        document.querySelectorAll('.gallery-grid img').forEach(img => {
          img.addEventListener('click', () => {
            lbImg.src = img.getAttribute('data-fullsrc') || img.src;
            if(typeof lb.showModal === 'function') lb.showModal();
          }, {passive:true});
        });
        lbClose && lbClose.addEventListener('click', ()=> lb.close());
        lb.addEventListener('click', (e)=>{ if(e.target===lb) lb.close(); });
        window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && lb.open) lb.close(); });
      }
      // 外連圖片容錯（避免部分站點阻擋 hotlink）
      function proxyURL(u, opts={}){
        try{
          const x = new URL(u);
          const params = new URLSearchParams();
          const w = opts.w || 1280; // responsive enough for mobile/most laptops
          params.set('url', x.host + x.pathname + (x.search||''));
          params.set('w', w);
          params.set('output', 'webp');
          return 'https://images.weserv.nl/?' + params.toString();
        }catch(e){
          return u;
        }
      }
      function bindImgFallback(){
        const attach = (img)=>{
          const toProxy = () => {
            if(img.dataset.fallback) return;
            img.dataset.fallback = '1';
            img.src = proxyURL(img.src);
          };
          // 1) On hard error, switch to proxy immediately
          img.addEventListener('error', toProxy, {passive:true});
          // 2) Smart fallback: if not loaded within 2500ms after intersecting, switch to proxy
          let timer = null;
          const onEnter = (entries)=>{
            entries.forEach(en=>{
              if(en.isIntersecting){
                if(img.complete) return; // already cached/loaded
                if(timer) return;
                timer = setTimeout(()=>{ if(!img.complete) toProxy(); }, 2500);
              }
            });
          };
          // Use per-image IO so timing is isolated
          const io = new IntersectionObserver(onEnter, {rootMargin: '200px'});
          io.observe(img);
          // Clear timer on successful load
          img.addEventListener('load', ()=>{ if(timer){ clearTimeout(timer); timer=null; } }, {passive:true});
        };
        document.querySelectorAll('img').forEach(attach);
        const obs = new MutationObserver((muts)=>{
          muts.forEach(m=>{
            m.addedNodes && m.addedNodes.forEach(node=>{
              if(node.nodeType===1){
                if(node.tagName==='IMG') attach(node);
                node.querySelectorAll && node.querySelectorAll('img').forEach(attach);
              }
            });
          });
        });
        obs.observe(document.body, {childList:true, subtree:true});
      }
      // 初始化
      renderItinerary();
            bindModeToggle();
      bindLightbox();
      bindImgFallback();
    </script>
  </body>
</html>
